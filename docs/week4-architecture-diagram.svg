<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 3200" font-family="Arial, sans-serif">
  <!-- Title -->
  <text x="800" y="40" font-size="28" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    Week 4 - Database &amp; Caching Architecture
  </text>
  <text x="800" y="70" font-size="16" text-anchor="middle" fill="#7f8c8d">
    PostgreSQL 18 + Redis + TypeScript Integration
  </text>

  <!-- Legend -->
  <rect x="50" y="90" width="1500" height="80" fill="#ecf0f1" stroke="#95a5a6" stroke-width="2" rx="5"/>
  <text x="800" y="115" font-size="16" font-weight="bold" text-anchor="middle" fill="#2c3e50">Legend</text>

  <rect x="100" y="130" width="30" height="20" fill="#9b59b6" stroke="#8e44ad" stroke-width="2"/>
  <text x="140" y="145" font-size="12" text-anchor="start" fill="#2c3e50">Application Layer</text>

  <rect x="350" y="130" width="30" height="20" fill="#3498db" stroke="#2980b9" stroke-width="2"/>
  <text x="390" y="145" font-size="12" text-anchor="start" fill="#2c3e50">PostgreSQL (Persistent)</text>

  <rect x="650" y="130" width="30" height="20" fill="#e74c3c" stroke="#c0392b" stroke-width="2"/>
  <text x="690" y="145" font-size="12" text-anchor="start" fill="#2c3e50">Redis (In-Memory)</text>

  <rect x="950" y="130" width="30" height="20" fill="#27ae60" stroke="#229954" stroke-width="2"/>
  <text x="990" y="145" font-size="12" text-anchor="start" fill="#2c3e50">Security Layer</text>

  <rect x="1250" y="130" width="30" height="20" fill="#f39c12" stroke="#d68910" stroke-width="2"/>
  <text x="1290" y="145" font-size="12" text-anchor="start" fill="#2c3e50">Data Flow</text>

  <!-- Application Layer -->
  <rect x="50" y="200" width="1500" height="280" fill="#f3e5f5" stroke="#8e44ad" stroke-width="3" rx="5"/>
  <text x="800" y="230" font-size="20" font-weight="bold" text-anchor="middle" fill="#8e44ad">
    TypeScript Application Layer (Node.js)
  </text>

  <!-- Scripts -->
  <rect x="100" y="250" width="450" height="210" fill="#9b59b6" stroke="#7d3c98" stroke-width="2" rx="5"/>
  <text x="325" y="280" font-size="16" font-weight="bold" text-anchor="middle" fill="white">Scripts (scripts/week4/)</text>
  <text x="120" y="305" font-size="11" text-anchor="start" fill="white">‚Ä¢ db-test.js - Connection testing</text>
  <text x="120" y="325" font-size="11" text-anchor="start" fill="white">‚Ä¢ db-transfer.js - App-level transactions</text>
  <text x="120" y="345" font-size="11" text-anchor="start" fill="white">‚Ä¢ db-transfer-sp.js - Stored procedures</text>
  <text x="120" y="365" font-size="11" text-anchor="start" fill="white">‚Ä¢ test-gdpr-export.ts - GDPR compliance</text>
  <text x="120" y="385" font-size="11" text-anchor="start" fill="white">‚Ä¢ backup-database.ps1 - Automated backups</text>
  <text x="120" y="415" font-size="12" font-weight="bold" text-anchor="start" fill="#ffeb3b">Performance:</text>
  <text x="120" y="435" font-size="10" text-anchor="start" fill="white">Stored proc: 55% faster (1 call vs 8+)</text>

  <!-- Modules -->
  <rect x="600" y="250" width="450" height="210" fill="#8e44ad" stroke="#6c3483" stroke-width="2" rx="5"/>
  <text x="825" y="280" font-size="16" font-weight="bold" text-anchor="middle" fill="white">Core Modules (src/)</text>
  <text x="620" y="305" font-size="11" text-anchor="start" fill="white">‚Ä¢ db/connection.ts - 3 connection pools</text>
  <text x="620" y="325" font-size="11" text-anchor="start" fill="white">‚Ä¢ db/transactions.ts - Double-entry</text>
  <text x="620" y="345" font-size="11" text-anchor="start" fill="white">‚Ä¢ cache/redis.ts - Redis connection</text>
  <text x="620" y="365" font-size="11" text-anchor="start" fill="white">‚Ä¢ cache/balance-cache.ts - Cache-Aside</text>
  <text x="620" y="385" font-size="11" text-anchor="start" fill="white">‚Ä¢ cache/profile-cache.ts - Hashes</text>
  <text x="620" y="405" font-size="11" text-anchor="start" fill="white">‚Ä¢ cache/publisher/subscriber.ts - Pub/Sub</text>
  <text x="620" y="425" font-size="11" text-anchor="start" fill="white">‚Ä¢ utils/encryption.ts - AES-256-GCM</text>

  <!-- Tests -->
  <rect x="1100" y="250" width="400" height="210" fill="#7d3c98" stroke="#5b2c6f" stroke-width="2" rx="5"/>
  <text x="1300" y="280" font-size="16" font-weight="bold" text-anchor="middle" fill="white">Test Coverage</text>
  <text x="1120" y="310" font-size="12" font-weight="bold" text-anchor="start" fill="#ffeb3b">Unit Tests (16):</text>
  <text x="1120" y="330" font-size="10" text-anchor="start" fill="white">‚Ä¢ encryption.test.ts</text>
  <text x="1120" y="360" font-size="12" font-weight="bold" text-anchor="start" fill="#ffeb3b">Integration Tests (46):</text>
  <text x="1120" y="380" font-size="10" text-anchor="start" fill="white">‚Ä¢ gdpr.test.ts (14)</text>
  <text x="1120" y="400" font-size="10" text-anchor="start" fill="white">‚Ä¢ transactions.test.ts (18)</text>
  <text x="1120" y="420" font-size="10" text-anchor="start" fill="white">‚Ä¢ rbac.test.ts (14)</text>
  <text x="1120" y="445" font-size="13" font-weight="bold" text-anchor="start" fill="#2ecc71">Total: 62 tests, 100% pass rate ‚úÖ</text>

  <!-- Arrow down -->
  <text x="400" y="510" font-size="14" font-weight="bold" text-anchor="middle" fill="#7f8c8d">
    ‚Üì uses (3 pools) ‚Üì
  </text>
  <text x="1100" y="510" font-size="14" font-weight="bold" text-anchor="middle" fill="#7f8c8d">
    ‚Üì uses ‚Üì
  </text>

  <!-- PostgreSQL Section -->
  <rect x="50" y="540" width="750" height="700" fill="#e3f2fd" stroke="#1976d2" stroke-width="3" rx="5"/>
  <text x="425" y="575" font-size="22" font-weight="bold" text-anchor="middle" fill="#01579b">
    PostgreSQL 18.x (Persistent, Disk-based)
  </text>

  <!-- Connection Pools -->
  <rect x="100" y="600" width="650" height="280" fill="#2196f3" stroke="#1565c0" stroke-width="2" rx="5"/>
  <text x="425" y="630" font-size="16" font-weight="bold" text-anchor="middle" fill="white">Connection Pools (RBAC - Least Privilege)</text>

  <rect x="130" y="650" width="580" height="70" fill="#42a5f5" stroke="#1e88e5" stroke-width="2" rx="5"/>
  <text x="420" y="675" font-size="13" font-weight="bold" text-anchor="middle" fill="white">api_service (app_readwrite)</text>
  <text x="150" y="695" font-size="11" text-anchor="start" fill="white">‚Ä¢ SELECT, INSERT, UPDATE, DELETE</text>
  <text x="150" y="712" font-size="11" text-anchor="start" fill="white">‚Ä¢ Normal operations ‚Ä¢ Cannot do DDL</text>

  <rect x="130" y="730" width="580" height="70" fill="#64b5f6" stroke="#2196f3" stroke-width="2" rx="5"/>
  <text x="420" y="755" font-size="13" font-weight="bold" text-anchor="middle" fill="white">migration_service (app_admin)</text>
  <text x="150" y="775" font-size="11" text-anchor="start" fill="white">‚Ä¢ ALL PRIVILEGES ‚Ä¢ CREATE/DROP/ALTER</text>
  <text x="150" y="792" font-size="11" text-anchor="start" fill="white">‚Ä¢ Schema migrations ‚Ä¢ Test setup</text>

  <rect x="130" y="810" width="580" height="60" fill="#90caf9" stroke="#42a5f5" stroke-width="2" rx="5"/>
  <text x="420" y="835" font-size="13" font-weight="bold" text-anchor="middle" fill="white">analytics_service (app_readonly)</text>
  <text x="150" y="855" font-size="11" text-anchor="start" fill="white">‚Ä¢ SELECT only ‚Ä¢ Reports &amp; Analytics ‚Ä¢ No writes</text>

  <!-- Database Objects -->
  <rect x="100" y="900" width="300" height="320" fill="#1976d2" stroke="#0d47a1" stroke-width="2" rx="5"/>
  <text x="250" y="930" font-size="15" font-weight="bold" text-anchor="middle" fill="white">Database: familychain</text>
  <text x="120" y="960" font-size="12" font-weight="bold" text-anchor="start" fill="#ffeb3b">Tables (9):</text>
  <text x="120" y="980" font-size="10" text-anchor="start" fill="white">‚Ä¢ family_members (user data)</text>
  <text x="120" y="997" font-size="10" text-anchor="start" fill="white">‚Ä¢ accounts (balances)</text>
  <text x="120" y="1014" font-size="10" text-anchor="start" fill="white">‚Ä¢ transactions (immutable)</text>
  <text x="120" y="1031" font-size="10" text-anchor="start" fill="white">‚Ä¢ ledger_entries (double-entry)</text>
  <text x="120" y="1048" font-size="10" text-anchor="start" fill="white">‚Ä¢ audit_log (JSONB)</text>
  <text x="120" y="1065" font-size="10" text-anchor="start" fill="white">‚Ä¢ blockchain_transactions</text>
  <text x="120" y="1082" font-size="10" text-anchor="start" fill="white">‚Ä¢ exchange_rates</text>
  <text x="120" y="1099" font-size="10" text-anchor="start" fill="white">‚Ä¢ +2 more</text>

  <text x="120" y="1130" font-size="12" font-weight="bold" text-anchor="start" fill="#ffeb3b">Stored Procedures:</text>
  <text x="120" y="1150" font-size="10" text-anchor="start" fill="white">‚Ä¢ create_transfer_transaction()</text>
  <text x="120" y="1167" font-size="10" text-anchor="start" fill="white">‚Ä¢ transfer_funds()</text>
  <text x="120" y="1184" font-size="10" text-anchor="start" fill="white">‚Ä¢ audit_trigger_func()</text>

  <text x="120" y="1210" font-size="11" font-weight="bold" text-anchor="start" fill="#2ecc71">55% faster than app-level! üöÄ</text>

  <!-- Triggers and Indexes -->
  <rect x="430" y="900" width="320" height="320" fill="#0d47a1" stroke="#01579b" stroke-width="2" rx="5"/>
  <text x="590" y="930" font-size="15" font-weight="bold" text-anchor="middle" fill="white">Triggers &amp; Indexes</text>
  <text x="450" y="960" font-size="12" font-weight="bold" text-anchor="start" fill="#ffeb3b">Triggers (2):</text>
  <text x="450" y="980" font-size="10" text-anchor="start" fill="white">‚Ä¢ audit_accounts</text>
  <text x="450" y="997" font-size="10" text-anchor="start" fill="white">‚Ä¢ audit_transactions</text>
  <text x="450" y="1020" font-size="9" font-style="italic" text-anchor="start" fill="white">Captures INSERT/UPDATE/DELETE</text>
  <text x="450" y="1037" font-size="9" font-style="italic" text-anchor="start" fill="white">Stores old/new values as JSONB</text>

  <text x="450" y="1070" font-size="12" font-weight="bold" text-anchor="start" fill="#ffeb3b">Indexes (8):</text>
  <text x="450" y="1090" font-size="10" text-anchor="start" fill="white">‚Ä¢ idx_transactions_account_id</text>
  <text x="450" y="1107" font-size="10" text-anchor="start" fill="white">‚Ä¢ idx_ledger_entries_tx_id</text>
  <text x="450" y="1124" font-size="10" text-anchor="start" fill="white">‚Ä¢ idx_blockchain_tx_hash</text>
  <text x="450" y="1141" font-size="10" text-anchor="start" fill="white">‚Ä¢ +5 more</text>

  <text x="450" y="1175" font-size="12" font-weight="bold" text-anchor="start" fill="#ffeb3b">Port: 5432</text>
  <text x="450" y="1200" font-size="11" text-anchor="start" fill="white">Response time: 5-50ms</text>

  <!-- Redis Section -->
  <rect x="850" y="540" width="700" height="700" fill="#ffebee" stroke="#c62828" stroke-width="3" rx="5"/>
  <text x="1200" y="575" font-size="22" font-weight="bold" text-anchor="middle" fill="#b71c1c">
    Redis (In-Memory, Volatile)
  </text>

  <!-- Redis Container Info -->
  <rect x="900" y="600" width="600" height="100" fill="#e74c3c" stroke="#c0392b" stroke-width="2" rx="5"/>
  <text x="1200" y="630" font-size="15" font-weight="bold" text-anchor="middle" fill="white">Docker Container</text>
  <text x="920" y="655" font-size="12" text-anchor="start" fill="white">Container: redis-familychain</text>
  <text x="920" y="675" font-size="12" text-anchor="start" fill="white">Port: 6379 ‚Ä¢ Started via Docker</text>
  <text x="920" y="695" font-size="12" font-weight="bold" text-anchor="start" fill="#ffeb3b">Response time: 0.1-1ms (50-108x faster!)</text>

  <!-- Data Structures -->
  <rect x="900" y="720" width="280" height="230" fill="#c0392b" stroke="#922b21" stroke-width="2" rx="5"/>
  <text x="1040" y="750" font-size="15" font-weight="bold" text-anchor="middle" fill="white">Data Structures</text>
  <text x="920" y="780" font-size="12" font-weight="bold" text-anchor="start" fill="#ffeb3b">‚Ä¢ Strings (Key-Value)</text>
  <text x="930" y="800" font-size="10" text-anchor="start" fill="white">Balance caching</text>
  <text x="920" y="825" font-size="12" font-weight="bold" text-anchor="start" fill="#ffeb3b">‚Ä¢ Hashes (Objects)</text>
  <text x="930" y="845" font-size="10" text-anchor="start" fill="white">User profiles (108x faster!)</text>
  <text x="920" y="870" font-size="12" font-weight="bold" text-anchor="start" fill="#ffeb3b">‚Ä¢ Lists (Ordered)</text>
  <text x="930" y="890" font-size="10" text-anchor="start" fill="white">Recent transactions</text>
  <text x="920" y="915" font-size="12" font-weight="bold" text-anchor="start" fill="#ffeb3b">‚Ä¢ Pub/Sub (Messaging)</text>
  <text x="930" y="935" font-size="10" text-anchor="start" fill="white">Real-time events</text>

  <!-- Caching Strategies -->
  <rect x="1220" y="720" width="280" height="230" fill="#922b21" stroke="#7b241c" stroke-width="2" rx="5"/>
  <text x="1360" y="750" font-size="15" font-weight="bold" text-anchor="middle" fill="white">Caching Strategies</text>
  <text x="1240" y="780" font-size="12" font-weight="bold" text-anchor="start" fill="#ffeb3b">Cache-Aside (Lazy Load):</text>
  <text x="1250" y="800" font-size="10" text-anchor="start" fill="white">1. Check cache first</text>
  <text x="1250" y="817" font-size="10" text-anchor="start" fill="white">2. If miss ‚Üí query DB</text>
  <text x="1250" y="834" font-size="10" text-anchor="start" fill="white">3. Store in cache</text>
  <text x="1250" y="851" font-size="10" text-anchor="start" fill="white">4. Return data</text>

  <text x="1240" y="880" font-size="12" font-weight="bold" text-anchor="start" fill="#ffeb3b">TTL (Time To Live):</text>
  <text x="1250" y="900" font-size="10" text-anchor="start" fill="white">‚Ä¢ 60s for balances</text>
  <text x="1250" y="917" font-size="10" text-anchor="start" fill="white">‚Ä¢ 300s for profiles</text>
  <text x="1250" y="934" font-size="10" text-anchor="start" fill="white">‚Ä¢ Prevents memory leaks</text>

  <!-- Performance -->
  <rect x="900" y="970" width="600" height="250" fill="#e74c3c" stroke="#c0392b" stroke-width="2" rx="5"/>
  <text x="1200" y="1000" font-size="16" font-weight="bold" text-anchor="middle" fill="white">Performance Measurements</text>

  <text x="920" y="1030" font-size="13" font-weight="bold" text-anchor="start" fill="#ffeb3b">Balance Cache:</text>
  <text x="930" y="1050" font-size="11" text-anchor="start" fill="white">First call (PostgreSQL): ~50ms</text>
  <text x="930" y="1068" font-size="11" text-anchor="start" fill="white">Second call (Redis): ~1ms</text>
  <text x="930" y="1086" font-size="12" font-weight="bold" text-anchor="start" fill="#2ecc71">üöÄ 50x faster!</text>

  <text x="920" y="1120" font-size="13" font-weight="bold" text-anchor="start" fill="#ffeb3b">Profile Cache:</text>
  <text x="930" y="1140" font-size="11" text-anchor="start" fill="white">First call (PostgreSQL): ~108ms</text>
  <text x="930" y="1158" font-size="11" text-anchor="start" fill="white">Second call (Redis): ~1ms</text>
  <text x="930" y="1176" font-size="12" font-weight="bold" text-anchor="start" fill="#2ecc71">üöÄ 108x faster!</text>

  <text x="920" y="1210" font-size="12" font-weight="bold" text-anchor="start" fill="#ffeb3b">Target Cache Hit Rate: 80-95%</text>

  <!-- Security Layer -->
  <rect x="50" y="1280" width="1500" height="320" fill="#e8f5e9" stroke="#2e7d32" stroke-width="3" rx="5"/>
  <text x="800" y="1315" font-size="22" font-weight="bold" text-anchor="middle" fill="#1b5e20">
    Security &amp; Encryption Layer
  </text>

  <!-- Encryption -->
  <rect x="100" y="1340" width="700" height="240" fill="#66bb6a" stroke="#43a047" stroke-width="2" rx="5"/>
  <text x="450" y="1370" font-size="16" font-weight="bold" text-anchor="middle" fill="white">AES-256-GCM (Authenticated Encryption)</text>

  <text x="120" y="1400" font-size="12" font-weight="bold" text-anchor="start" fill="#fffde7">Algorithm: AES-256-GCM</text>
  <text x="130" y="1420" font-size="11" text-anchor="start" fill="white">‚Ä¢ Key: 256-bit (ENCRYPTION_KEY env var)</text>
  <text x="130" y="1438" font-size="11" text-anchor="start" fill="white">‚Ä¢ IV: Random 16 bytes per encryption</text>
  <text x="130" y="1456" font-size="11" text-anchor="start" fill="white">‚Ä¢ Auth Tag: Detects tampering</text>
  <text x="130" y="1474" font-size="11" text-anchor="start" fill="white">‚Ä¢ Format: iv:encrypted:authTag (base64)</text>

  <text x="120" y="1505" font-size="12" font-weight="bold" text-anchor="start" fill="#fffde7">Encrypted Fields:</text>
  <text x="130" y="1525" font-size="11" text-anchor="start" fill="white">‚Ä¢ family_members.iban_encrypted (banking IBAN)</text>
  <text x="130" y="1543" font-size="11" text-anchor="start" fill="white">‚Ä¢ family_members.nif_encrypted (tax ID)</text>
  <text x="130" y="1561" font-size="11" text-anchor="start" fill="white">‚Ä¢ NOT encrypted: email, name, wallet_address</text>

  <!-- GDPR -->
  <rect x="850" y="1340" width="650" height="240" fill="#43a047" stroke="#2e7d32" stroke-width="2" rx="5"/>
  <text x="1175" y="1370" font-size="16" font-weight="bold" text-anchor="middle" fill="white">GDPR Compliance</text>

  <text x="870" y="1400" font-size="13" font-weight="bold" text-anchor="start" fill="#fffde7">Right to Data Portability:</text>
  <text x="880" y="1420" font-size="11" text-anchor="start" fill="white">‚Ä¢ Export all user data (decrypted)</text>
  <text x="880" y="1438" font-size="11" text-anchor="start" fill="white">‚Ä¢ Machine-readable JSON format</text>
  <text x="880" y="1456" font-size="11" text-anchor="start" fill="white">‚Ä¢ Includes: profile, accounts, transactions, audit logs</text>

  <text x="870" y="1485" font-size="13" font-weight="bold" text-anchor="start" fill="#fffde7">Right to Erasure (Right to Be Forgotten):</text>
  <text x="880" y="1505" font-size="11" text-anchor="start" fill="white">‚Ä¢ Anonymize (NOT delete) for financial data</text>
  <text x="880" y="1523" font-size="11" text-anchor="start" fill="white">‚Ä¢ name ‚Üí "Deleted User 123"</text>
  <text x="880" y="1541" font-size="11" text-anchor="start" fill="white">‚Ä¢ email, IBAN, NIF ‚Üí NULL</text>
  <text x="880" y="1559" font-size="11" text-anchor="start" fill="white">‚Ä¢ Preserve transactions (audit trail requirement)</text>

  <!-- Data Flow Examples -->
  <rect x="50" y="1640" width="1500" height="700" fill="#fff9c4" stroke="#f57f17" stroke-width="3" rx="5"/>
  <text x="800" y="1680" font-size="22" font-weight="bold" text-anchor="middle" fill="#e65100">
    Data Flow Patterns
  </text>

  <!-- Flow 1: Cache-Aside -->
  <rect x="100" y="1710" width="700" height="180" fill="#fff59d" stroke="#f9a825" stroke-width="2" rx="5"/>
  <text x="450" y="1740" font-size="15" font-weight="bold" text-anchor="middle" fill="#e65100">1. CACHE-ASIDE PATTERN (Balance Query)</text>

  <rect x="130" y="1760" width="640" height="110" fill="#f39c12" stroke="#e67e22" stroke-width="2" rx="5"/>
  <text x="150" y="1785" font-size="11" font-family="Courier New" text-anchor="start" fill="white">Application ‚Üí Check Redis Cache</text>
  <text x="150" y="1805" font-size="11" font-family="Courier New" text-anchor="start" fill="white">‚îú‚îÄ Cache HIT: Return balance (1ms)</text>
  <text x="150" y="1825" font-size="11" font-family="Courier New" text-anchor="start" fill="white">‚îî‚îÄ Cache MISS:</text>
  <text x="170" y="1845" font-size="11" font-family="Courier New" text-anchor="start" fill="white">‚Üí Query PostgreSQL (50ms)</text>
  <text x="170" y="1865" font-size="11" font-family="Courier New" text-anchor="start" fill="white">‚Üí Store in Redis with 60s TTL</text>

  <!-- Flow 2: Double-Entry Bookkeeping -->
  <rect x="850" y="1710" width="650" height="180" fill="#ffecb3" stroke="#ff6f00" stroke-width="2" rx="5"/>
  <text x="1175" y="1740" font-size="15" font-weight="bold" text-anchor="middle" fill="#e65100">2. DOUBLE-ENTRY TRANSFER</text>

  <rect x="880" y="1760" width="590" height="110" fill="#d68910" stroke="#ca6f1e" stroke-width="2" rx="5"/>
  <text x="900" y="1785" font-size="11" font-family="Courier New" text-anchor="start" fill="white">create_transfer_transaction(from, to, amount)</text>
  <text x="900" y="1805" font-size="10" font-family="Courier New" text-anchor="start" fill="white">‚îú‚îÄ Lock accounts (FOR UPDATE)</text>
  <text x="900" y="1822" font-size="10" font-family="Courier New" text-anchor="start" fill="white">‚îú‚îÄ INSERT transaction</text>
  <text x="900" y="1839" font-size="10" font-family="Courier New" text-anchor="start" fill="white">‚îú‚îÄ INSERT debit ledger_entry (sender)</text>
  <text x="900" y="1856" font-size="10" font-family="Courier New" text-anchor="start" fill="white">‚îî‚îÄ INSERT credit ledger_entry (receiver)</text>

  <!-- Flow 3: Blockchain Linking -->
  <rect x="100" y="1910" width="700" height="180" fill="#fff59d" stroke="#f9a825" stroke-width="2" rx="5"/>
  <text x="450" y="1940" font-size="15" font-weight="bold" text-anchor="middle" fill="#e65100">3. BLOCKCHAIN LINKING</text>

  <rect x="130" y="1960" width="640" height="110" fill="#f39c12" stroke="#e67e22" stroke-width="2" rx="5"/>
  <text x="150" y="1985" font-size="11" font-family="Courier New" text-anchor="start" fill="white">linkBlockchainTransaction(tx_hash)</text>
  <text x="150" y="2005" font-size="10" font-family="Courier New" text-anchor="start" fill="white">‚îú‚îÄ Fetch tx from Sepolia (via Alchemy)</text>
  <text x="150" y="2022" font-size="10" font-family="Courier New" text-anchor="start" fill="white">‚îú‚îÄ INSERT blockchain_transactions</text>
  <text x="150" y="2039" font-size="10" font-family="Courier New" text-anchor="start" fill="white">‚îî‚îÄ INSERT transactions (internal record)</text>
  <text x="150" y="2060" font-size="10" font-weight="bold" text-anchor="start" fill="#2ecc71">Result: On-chain proof + family context</text>

  <!-- Flow 4: Pub/Sub -->
  <rect x="850" y="1910" width="650" height="180" fill="#ffecb3" stroke="#ff6f00" stroke-width="2" rx="5"/>
  <text x="1175" y="1940" font-size="15" font-weight="bold" text-anchor="middle" fill="#e65100">4. PUB/SUB PATTERN</text>

  <rect x="880" y="1960" width="590" height="110" fill="#d68910" stroke="#ca6f1e" stroke-width="2" rx="5"/>
  <text x="900" y="1985" font-size="11" font-family="Courier New" text-anchor="start" fill="white">Publisher ‚Üí Redis channel ("transaction")</text>
  <text x="900" y="2005" font-size="10" font-family="Courier New" text-anchor="start" fill="white">‚Üí Subscribers receive event immediately</text>
  <text x="900" y="2025" font-size="10" font-family="Courier New" text-anchor="start" fill="white">‚Üí No polling needed</text>
  <text x="900" y="2045" font-size="10" font-weight="bold" text-anchor="start" fill="#ffeb3b">‚ö† Separate client required (protocol limit)</text>

  <!-- Flow 5: GDPR Export -->
  <rect x="100" y="2110" width="700" height="210" fill="#fff59d" stroke="#f9a825" stroke-width="2" rx="5"/>
  <text x="450" y="2140" font-size="15" font-weight="bold" text-anchor="middle" fill="#e65100">5. GDPR EXPORT</text>

  <rect x="130" y="2160" width="640" height="140" fill="#f39c12" stroke="#e67e22" stroke-width="2" rx="5"/>
  <text x="150" y="2185" font-size="11" font-family="Courier New" text-anchor="start" fill="white">exportUserData(user_id)</text>
  <text x="150" y="2205" font-size="10" font-family="Courier New" text-anchor="start" fill="white">‚îú‚îÄ SELECT family_members (decrypt IBAN/NIF)</text>
  <text x="150" y="2222" font-size="10" font-family="Courier New" text-anchor="start" fill="white">‚îú‚îÄ SELECT all accounts</text>
  <text x="150" y="2239" font-size="10" font-family="Courier New" text-anchor="start" fill="white">‚îú‚îÄ SELECT all transactions</text>
  <text x="150" y="2256" font-size="10" font-family="Courier New" text-anchor="start" fill="white">‚îú‚îÄ SELECT audit_log entries</text>
  <text x="150" y="2273" font-size="10" font-family="Courier New" text-anchor="start" fill="white">‚îî‚îÄ Compile into JSON</text>

  <!-- Flow 6: Row Locking -->
  <rect x="850" y="2110" width="650" height="210" fill="#ffecb3" stroke="#ff6f00" stroke-width="2" rx="5"/>
  <text x="1175" y="2140" font-size="15" font-weight="bold" text-anchor="middle" fill="#e65100">6. ROW LOCKING (Race Prevention)</text>

  <rect x="880" y="2160" width="590" height="140" fill="#d68910" stroke="#ca6f1e" stroke-width="2" rx="5"/>
  <text x="900" y="2185" font-size="11" font-family="Courier New" text-anchor="start" fill="white">SELECT balance FROM accounts</text>
  <text x="900" y="2203" font-size="11" font-family="Courier New" text-anchor="start" fill="white">WHERE id = $1 FOR UPDATE;</text>
  <text x="900" y="2225" font-size="10" text-anchor="start" fill="white">‚Ä¢ Locks row until COMMIT</text>
  <text x="900" y="2243" font-size="10" text-anchor="start" fill="white">‚Ä¢ Prevents TOCTOU (Time-Of-Check to Time-Of-Use)</text>
  <text x="900" y="2261" font-size="10" text-anchor="start" fill="white">‚Ä¢ Lock held for ~1-5ms</text>
  <text x="900" y="2279" font-size="10" font-weight="bold" text-anchor="start" fill="#2ecc71">‚úÖ Correctness &gt; Speed</text>

  <!-- Financial Data Modeling -->
  <rect x="50" y="2380" width="1500" height="300" fill="#e8eaf6" stroke="#283593" stroke-width="3" rx="5"/>
  <text x="800" y="2420" font-size="22" font-weight="bold" text-anchor="middle" fill="#1a237e">
    Financial Data Modeling Principles
  </text>

  <!-- NUMERIC Types -->
  <rect x="100" y="2450" width="450" height="210" fill="#5c6bc0" stroke="#3f51b5" stroke-width="2" rx="5"/>
  <text x="325" y="2480" font-size="15" font-weight="bold" text-anchor="middle" fill="white">1. NUMERIC TYPES</text>
  <text x="120" y="2505" font-size="11" text-anchor="start" fill="#ffeb3b">‚ùå Why FLOAT fails:</text>
  <text x="130" y="2525" font-size="10" text-anchor="start" fill="white">‚Ä¢ 0.1 + 0.2 = 0.30000000000000004</text>
  <text x="130" y="2543" font-size="10" text-anchor="start" fill="white">‚Ä¢ Binary fractions (not decimal)</text>
  <text x="130" y="2561" font-size="10" text-anchor="start" fill="white">‚Ä¢ 1000 ops = lose ~$0.17</text>

  <text x="120" y="2590" font-size="11" text-anchor="start" fill="#2ecc71">‚úÖ Use NUMERIC:</text>
  <text x="130" y="2610" font-size="10" text-anchor="start" fill="white">‚Ä¢ NUMERIC(28, 18) for ETH (18 decimals)</text>
  <text x="130" y="2628" font-size="10" text-anchor="start" fill="white">‚Ä¢ NUMERIC(20, 8) for general money</text>
  <text x="130" y="2646" font-size="10" text-anchor="start" fill="white">‚Ä¢ Exact decimal arithmetic, no rounding</text>

  <!-- Immutability -->
  <rect x="600" y="2450" width="450" height="210" fill="#3f51b5" stroke="#303f9f" stroke-width="2" rx="5"/>
  <text x="825" y="2480" font-size="15" font-weight="bold" text-anchor="middle" fill="white">2. IMMUTABILITY</text>
  <text x="620" y="2510" font-size="11" text-anchor="start" fill="#ffeb3b">Problem: Sent +10 ETH by mistake</text>

  <text x="620" y="2540" font-size="11" text-anchor="start" fill="#e74c3c">‚ùå WRONG:</text>
  <text x="630" y="2560" font-size="10" text-anchor="start" fill="white">DELETE or UPDATE transaction</text>

  <text x="620" y="2590" font-size="11" text-anchor="start" fill="#2ecc71">‚úÖ CORRECT:</text>
  <text x="630" y="2610" font-size="10" text-anchor="start" fill="white">Create reversing transaction</text>
  <text x="630" y="2628" font-size="10" font-family="Courier New" text-anchor="start" fill="white">Original: +10 ETH (reversed_by: 2)</text>
  <text x="630" y="2646" font-size="10" font-family="Courier New" text-anchor="start" fill="white">Reversal: -10 ETH (tx_id: 2)</text>

  <!-- Double-Entry -->
  <rect x="1100" y="2450" width="400" height="210" fill="#283593" stroke="#1a237e" stroke-width="2" rx="5"/>
  <text x="1300" y="2480" font-size="15" font-weight="bold" text-anchor="middle" fill="white">3. DOUBLE-ENTRY</text>
  <text x="1120" y="2510" font-size="11" text-anchor="start" fill="#ffeb3b">Every transfer = 2 entries:</text>

  <text x="1120" y="2540" font-size="10" text-anchor="start" fill="white">1. Debit (sender - money OUT)</text>
  <text x="1120" y="2558" font-size="10" text-anchor="start" fill="white">2. Credit (receiver - money IN)</text>

  <text x="1120" y="2585" font-size="11" text-anchor="start" fill="#2ecc71">‚úÖ Benefits:</text>
  <text x="1130" y="2605" font-size="10" text-anchor="start" fill="white">‚Ä¢ Complete audit trail</text>
  <text x="1130" y="2623" font-size="10" text-anchor="start" fill="white">‚Ä¢ Faster queries</text>
  <text x="1130" y="2641" font-size="10" text-anchor="start" fill="white">‚Ä¢ Self-auditing: SUM = 0</text>

  <!-- Real-World Integration -->
  <rect x="50" y="2720" width="1500" height="200" fill="#d1c4e9" stroke="#512da8" stroke-width="3" rx="5"/>
  <text x="800" y="2755" font-size="20" font-weight="bold" text-anchor="middle" fill="#311b92">
    Real-World Integration (Sepolia Testnet)
  </text>

  <rect x="100" y="2780" width="1400" height="120" fill="#673ab7" stroke="#5e35b1" stroke-width="2" rx="5"/>
  <text x="800" y="2810" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Linked Real Blockchain Transaction</text>
  <text x="120" y="2835" font-size="11" text-anchor="start" fill="white">TX Hash: 0x85324acc9e53f71dc1649839db5b33e620eadbdb295f5cc949443c7f084042fa</text>
  <text x="120" y="2855" font-size="11" text-anchor="start" fill="white">From: Alice Johnson (0xB09b5449D8BB84312Fbc4293baf122E0e1875736)</text>
  <text x="120" y="2875" font-size="11" text-anchor="start" fill="white">To: Bob Johnson (0x310a9DaB3c4B9406d6629E66a4b1D737e01C30B5)</text>
  <text x="900" y="2835" font-size="11" text-anchor="start" fill="white">Amount: 0.001 ETH</text>
  <text x="900" y="2855" font-size="11" text-anchor="start" fill="white">Block: 9,531,070</text>
  <text x="900" y="2875" font-size="11" text-anchor="start" fill="white">Confirmations: 68,451+ üîí</text>

  <!-- Key Concepts -->
  <rect x="50" y="2960" width="1500" height="200" fill="#e0f2f1" stroke="#00695c" stroke-width="3" rx="5"/>
  <text x="800" y="2995" font-size="20" font-weight="bold" text-anchor="middle" fill="#004d40">
    Key Concepts Learned in Week 4
  </text>

  <text x="100" y="3030" font-size="12" text-anchor="start" fill="#004d40">‚Ä¢ PostgreSQL = Source of truth (persistent, ACID) ‚Ä¢ Redis = Speed layer (50-108x faster)</text>
  <text x="100" y="3055" font-size="12" text-anchor="start" fill="#004d40">‚Ä¢ NUMERIC mandatory for money ‚Ä¢ Double-entry = self-auditing ‚Ä¢ Immutability = preserve history</text>
  <text x="100" y="3080" font-size="12" text-anchor="start" fill="#004d40">‚Ä¢ Row locking (FOR UPDATE) = prevent race conditions ‚Ä¢ Stored procedures = 55% faster</text>
  <text x="100" y="3105" font-size="12" text-anchor="start" fill="#004d40">‚Ä¢ AES-256-GCM = authenticated encryption ‚Ä¢ RBAC = least privilege ‚Ä¢ TTL = prevent memory leaks</text>
  <text x="100" y="3130" font-size="12" text-anchor="start" fill="#004d40">‚Ä¢ JSONB = flexible audit logs ‚Ä¢ Cache-Aside = lazy loading ‚Ä¢ Pub/Sub = real-time messaging</text>

  <!-- Footer -->
  <rect x="50" y="3180" width="1500" height="20" fill="#2c3e50" stroke="#1a252f" stroke-width="2" rx="5"/>
  <text x="800" y="3195" font-size="13" font-weight="bold" text-anchor="middle" fill="white">
    Week 4 Achievement: Production-ready database foundation with 62 tests (100% pass rate) ‚Ä¢ 50-108x performance improvement ‚Ä¢ GDPR compliant
  </text>
</svg>
